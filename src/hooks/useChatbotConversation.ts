
import { useState, useEffect } from 'react';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/integrations/supabase/client';
import { Message, ChatLanguage, WasteAnalysisResult } from '@/types/chatbot';
import { 
  sampleResponses, 
  hindiTranslations, 
  generateRandomTrackingId 
} from '@/utils/chatbotUtils';
import { 
  analyzeWasteImage, 
  generateWasteAnalysisResponse 
} from '@/utils/wasteIdentificationUtils';

export const useChatbotConversation = () => {
  const [messages, setMessages] = useState<Message[]>([
    {
      id: 1,
      text: "Hello! I'm Nagarsathi, your municipal assistant. How can I help you today?",
      sender: "bot",
      timestamp: new Date(),
    },
  ]);
  const [input, setInput] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const [isImageAttached, setIsImageAttached] = useState(false);
  const [imagePreview, setImagePreview] = useState<string | null>(null);
  const [generatingResponse, setGeneratingResponse] = useState(false);
  const [currentLanguage, setCurrentLanguage] = useState<ChatLanguage>("english");
  const { toast } = useToast();
  const { user } = useAuth();

  // Save conversation to database if user is logged in
  const saveConversationToDatabase = async (userMessage: string, botResponse: string) => {
    if (!user) return;
    
    try {
      // Instead of trying to insert into chatbot_conversations table,
      // we'll use the feedback table since it's available in the database
      await supabase.from('feedback').insert({
        user_id: user.id,
        name: user.email?.split('@')[0] || 'User',
        email: user.email || 'user@example.com',
        subject: 'Chatbot Conversation',
        message: `User: ${userMessage}\nBot: ${botResponse}`
      });
    } catch (error) {
      console.error("Error saving conversation:", error);
    }
  };

  const switchLanguage = () => {
    const newLanguage = currentLanguage === "english" ? "hindi" : "english";
    setCurrentLanguage(newLanguage);
    
    // Update bot message based on language
    const welcomeMessage = newLanguage === "english" 
      ? "I've switched to English. How can I help you today?" 
      : "‡§Æ‡•à‡§Ç‡§®‡•á ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§µ‡§ø‡§ö ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?";
    
    const langMessage: Message = {
      id: Date.now(),
      text: welcomeMessage,
      sender: "bot",
      timestamp: new Date(),
    };
    
    setMessages(prev => [...prev, langMessage]);
    
    toast({
      title: newLanguage === "english" ? "Language Changed" : "‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•Ä ‡§ó‡§à",
      description: newLanguage === "english" ? "Now chatting in English" : "‡§Ö‡§¨ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ö‡•à‡§ü ‡§ï‡§∞‡•á‡§Ç",
      variant: "default",
    });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() && !isImageAttached) return;

    // Add user message
    const userMessage: Message = {
      id: messages.length + 1,
      text: input,
      sender: "user",
      timestamp: new Date(),
      ...(isImageAttached && imagePreview ? { 
        attachmentType: "image",
        attachmentUrl: imagePreview 
      } : {})
    };

    setMessages((prev) => [...prev, userMessage]);
    setInput("");
    setIsTyping(true);
    setGeneratingResponse(true);

    // Handle language switching
    if (input.toLowerCase().includes("hindi") || input.toLowerCase().includes("‡§π‡§ø‡§Ç‡§¶‡•Ä")) {
      setTimeout(() => {
        setCurrentLanguage("hindi");
        const response = hindiTranslations.welcome;
        
        const botMessage: Message = {
          id: messages.length + 2,
          text: response,
          sender: "bot",
          timestamp: new Date(),
        };
        
        setMessages((prev) => [...prev, botMessage]);
        setIsTyping(false);
        setGeneratingResponse(false);
      }, 1500);
      
      clearAttachment();
      return;
    }
    
    if (currentLanguage === "hindi" && (input.toLowerCase().includes("english") || input.toLowerCase().includes("‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä"))) {
      setTimeout(() => {
        setCurrentLanguage("english");
        const response = "I've switched to English. How can I help you today?";
        
        const botMessage: Message = {
          id: messages.length + 2,
          text: response,
          sender: "bot",
          timestamp: new Date(),
        };
        
        setMessages((prev) => [...prev, botMessage]);
        setIsTyping(false);
        setGeneratingResponse(false);
      }, 1500);
      
      clearAttachment();
      return;
    }

    // Check if this is a waste identification request with an image
    if (isImageAttached && imagePreview && 
        (input.toLowerCase().includes("waste") || 
         input.toLowerCase().includes("trash") ||
         input.toLowerCase().includes("garbage") ||
         input.toLowerCase().includes("recycle") ||
         input.toLowerCase().includes("dispose") ||
         input.toLowerCase().includes("identify") ||
         input.trim() === "")) {
      
      // Show waste analysis loading message
      const analysisLoadingMessage: Message = {
        id: messages.length + 2,
        text: currentLanguage === "english" 
          ? "Analyzing your waste image... This will take just a moment." 
          : "‡§Ü‡§™‡§ï‡•Ä ‡§ï‡§ö‡§∞‡•á ‡§ï‡•Ä ‡§õ‡§µ‡§ø ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à... ‡§Ø‡§π ‡§¨‡§∏ ‡§è‡§ï ‡§ï‡•ç‡§∑‡§£ ‡§≤‡•á‡§ó‡§æ‡•§",
        sender: "bot",
        timestamp: new Date(),
        status: "pending"
      };
      
      setMessages((prev) => [...prev, analysisLoadingMessage]);
      
      // Process the waste image
      analyzeWasteImage(imagePreview).then((analysisResult: WasteAnalysisResult) => {
        // Generate a detailed response about the waste
        const responseText = generateWasteAnalysisResponse(analysisResult, currentLanguage);
        
        // Add waste analysis results to chat
        const analysisResponseMessage: Message = {
          id: messages.length + 3,
          text: responseText,
          sender: "bot",
          timestamp: new Date(),
          wasteAnalysis: analysisResult
        };
        
        setMessages((prev) => {
          // Replace the loading message with the actual response
          const filteredMessages = prev.filter(msg => msg.id !== analysisLoadingMessage.id);
          return [...filteredMessages, analysisResponseMessage];
        });
        
        setIsTyping(false);
        setGeneratingResponse(false);
        
        // Add gamification message after successful waste identification
        setTimeout(() => {
          const gamificationMessage: Message = {
            id: Date.now(),
            text: currentLanguage === "english" 
              ? "üå± Great job identifying waste correctly! You've earned 5 eco-points. Keep properly disposing of waste to earn more points and badges." 
              : "üå± ‡§ï‡§ö‡§∞‡•á ‡§ï‡•Ä ‡§∏‡§π‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡§æ‡§¨‡§æ‡§∂! ‡§Ü‡§™‡§®‡•á 5 ‡§á‡§ï‡•ã-‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§ß‡§ø‡§ï ‡§Ö‡§Ç‡§ï ‡§î‡§∞ ‡§¨‡•à‡§ú ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ö‡§∞‡•á ‡§ï‡§æ ‡§â‡§ö‡§ø‡§§ ‡§®‡§ø‡§™‡§ü‡§æ‡§® ‡§ï‡§∞‡§§‡•á ‡§∞‡§π‡•á‡§Ç‡•§",
            sender: "bot",
            timestamp: new Date(),
            status: "success"
          };
          
          setMessages(prev => [...prev, gamificationMessage]);
          
          // Show toast for earned points
          toast({
            title: currentLanguage === "english" ? "+5 Eco-Points Earned!" : "+5 ‡§á‡§ï‡•ã-‡§™‡•â‡§á‡§Ç‡§ü‡•ç‡§∏ ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§!",
            description: currentLanguage === "english" 
              ? "Thank you for proper waste identification" 
              : "‡§â‡§ö‡§ø‡§§ ‡§ï‡§ö‡§∞‡§æ ‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶",
            variant: "default",
          });
        }, 3000);
        
        clearAttachment();
        
        // Save conversation to database if user is logged in
        if (user) {
          saveConversationToDatabase(input, responseText);
        }
      });
      
      return;
    }

    // Handle non-waste identification queries
    // Simulate AI processing
    setTimeout(() => {
      let response = "I'm sorry, I don't have information about that. Please contact our helpdesk for assistance.";
      
      // Check for keywords in the input
      const lowerInput = input.toLowerCase();
      const currentResponses = currentLanguage === "english" ? sampleResponses : hindiTranslations;
      
      // Add waste-related keywords to the existing responses
      if (lowerInput.includes("organic waste") || lowerInput.includes("food waste") || 
          lowerInput.includes("compost")) {
        response = currentLanguage === "english" 
          ? "Organic waste should be placed in green bins. It can be composted to create nutrient-rich soil. The municipality collects organic waste on Mondays and Thursdays."
          : "‡§ú‡•à‡§µ‡§ø‡§ï ‡§ï‡§ö‡§∞‡•á ‡§ï‡•ã ‡§π‡§∞‡•á ‡§°‡§ø‡§¨‡•ç‡§¨‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§á‡§∏‡•á ‡§ñ‡§æ‡§¶ ‡§¨‡§®‡§æ‡§ï‡§∞ ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ‡•ã‡§Ç ‡§∏‡•á ‡§≠‡§∞‡§™‡•Ç‡§∞ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ ‡§®‡§ó‡§∞ ‡§™‡§æ‡§≤‡§ø‡§ï‡§æ ‡§∏‡•ã‡§Æ‡§µ‡§æ‡§∞ ‡§î‡§∞ ‡§ó‡•Å‡§∞‡•Å‡§µ‡§æ‡§∞ ‡§ï‡•ã ‡§ú‡•à‡§µ‡§ø‡§ï ‡§ï‡§ö‡§∞‡§æ ‡§è‡§ï‡§§‡•ç‡§∞ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§";
      } else if (lowerInput.includes("recyclable") || lowerInput.includes("recycle")) {
        response = currentLanguage === "english" 
          ? "Recyclable materials like paper, plastic, glass, and metal should be cleaned and placed in blue bins. Make sure to separate different types of recyclables according to local guidelines."
          : "‡§ï‡§æ‡§ó‡§ú, ‡§™‡•ç‡§≤‡§æ‡§∏‡•ç‡§ü‡§ø‡§ï, ‡§ï‡§æ‡§Ç‡§ö ‡§î‡§∞ ‡§ß‡§æ‡§§‡•Å ‡§ú‡•à‡§∏‡•Ä ‡§∞‡•Ä‡§∏‡§æ‡§á‡§ï‡§ø‡§≤ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ï‡•ã ‡§∏‡§æ‡§´ ‡§ï‡§∞‡§ï‡•á ‡§®‡•Ä‡§≤‡•á ‡§¨‡§ø‡§® ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§¶‡§ø‡§∂‡§æ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§∞‡•Ä‡§∏‡§æ‡§á‡§ï‡§ø‡§≤ ‡§ï‡•ã ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡§®‡§æ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§";
      } else if (lowerInput.includes("hazardous") || lowerInput.includes("batteries") || 
                lowerInput.includes("chemical") || lowerInput.includes("electronic")) {
        response = currentLanguage === "english" 
          ? "Hazardous waste requires special handling. Never mix with regular trash. Take items like batteries, electronics, and chemicals to the designated collection center at Environmental Complex, Civil Lines, open on the first Saturday of each month."
          : "‡§ñ‡§§‡§∞‡§®‡§æ‡§ï ‡§ï‡§ö‡§∞‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§π‡•à‡§Ç‡§°‡§≤‡§ø‡§Ç‡§ó ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§ ‡§ï‡§≠‡•Ä ‡§≠‡•Ä ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§ï‡§ö‡§∞‡•á ‡§ï‡•á ‡§∏‡§æ‡§• ‡§® ‡§Æ‡§ø‡§≤‡§æ‡§è‡§Ç‡•§ ‡§¨‡•à‡§ü‡§∞‡•Ä, ‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•â‡§®‡§ø‡§ï‡•ç‡§∏ ‡§î‡§∞ ‡§∞‡§∏‡§æ‡§Ø‡§® ‡§ú‡•à‡§∏‡•Ä ‡§µ‡§∏‡•ç‡§§‡•Å‡§ì‡§Ç ‡§ï‡•ã ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§ï‡•â‡§Æ‡•ç‡§™‡•ç‡§≤‡•á‡§ï‡•ç‡§∏, ‡§∏‡§ø‡§µ‡§ø‡§≤ ‡§≤‡§æ‡§á‡§Ç‡§∏ ‡§Æ‡•á‡§Ç ‡§®‡§æ‡§Æ‡§ø‡§§ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§™‡§∞ ‡§≤‡•á ‡§ú‡§æ‡§è‡§Ç, ‡§ú‡•ã ‡§π‡§∞ ‡§Æ‡§π‡•Ä‡§®‡•á ‡§ï‡•á ‡§™‡§π‡§≤‡•á ‡§∂‡§®‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•ã ‡§ñ‡•Å‡§≤‡§æ ‡§∞‡§π‡§§‡§æ ‡§π‡•à‡•§";
      } else {
        // Use existing responses for non-waste queries
        for (const [keyword, reply] of Object.entries(currentResponses)) {
          if (lowerInput.includes(keyword)) {
            response = reply;
            if (keyword === "garbage" || keyword === "water" || keyword === "road") {
              // Add random ID for tracking
              response += generateRandomTrackingId();
              
              // Add status update for complaints
              setTimeout(() => {
                setMessages((prev) => [
                  ...prev,
                  {
                    id: prev.length + 2,
                    text: currentLanguage === "english" 
                      ? `UPDATE: Your ${keyword} complaint has been assigned to our field team. They will reach the location soon.` 
                      : `‡§Ö‡§™‡§°‡•á‡§ü: ‡§Ü‡§™‡§ï‡•Ä ${keyword} ‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§ ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§´‡•Ä‡§≤‡•ç‡§° ‡§ü‡•Ä‡§Æ ‡§ï‡•ã ‡§∏‡•å‡§Ç‡§™ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à‡•§ ‡§µ‡•á ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§™‡§π‡•Å‡§Ç‡§ö‡•á‡§Ç‡§ó‡•á‡•§`,
                    sender: "bot",
                    timestamp: new Date(),
                    status: "success"
                  }
                ]);
              }, 8000);
            }
            break;
          }
        }
      }

      // Handle regular image attachments (non-waste identification)
      if (isImageAttached && !lowerInput.includes("waste") && !lowerInput.includes("garbage") && 
          !lowerInput.includes("recycle")) {
        response = currentLanguage === "english"
          ? "Thank you for the image. I can see this is an issue that needs attention. I've logged this complaint with high priority. Expect resolution within 24 hours. Your tracking ID is #MC-2023-" + generateRandomTrackingId()
          : "‡§õ‡§µ‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§ ‡§Æ‡•à‡§Ç ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å ‡§ï‡§ø ‡§Ø‡§π ‡§è‡§ï ‡§ê‡§∏‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏ ‡§™‡§∞ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§Æ‡•à‡§Ç‡§®‡•á ‡§á‡§∏ ‡§∂‡§ø‡§ï‡§æ‡§Ø‡§§ ‡§ï‡•ã ‡§â‡§ö‡•ç‡§ö ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à‡•§ 24 ‡§ò‡§Ç‡§ü‡•á ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§∏‡§Æ‡§æ‡§ß‡§æ‡§® ‡§ï‡•Ä ‡§â‡§Æ‡•ç‡§Æ‡•Ä‡§¶ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó ‡§Ü‡§à‡§°‡•Ä ‡§π‡•à #MC-2023-" + generateRandomTrackingId();
        
        clearAttachment();
        
        // Show successful analysis toast
        toast({
          title: currentLanguage === "english" ? "Image Analysis Complete" : "‡§õ‡§µ‡§ø ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£",
          description: currentLanguage === "english" ? "Issue identified and logged" : "‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§™‡§π‡§ö‡§æ‡§®‡•Ä ‡§î‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡•Ä ‡§ó‡§à",
          variant: "default",
        });
      }

      // Add bot response
      const botMessage: Message = {
        id: messages.length + 2,
        text: response,
        sender: "bot",
        timestamp: new Date(),
      };
      
      setMessages((prev) => [...prev, botMessage]);
      setIsTyping(false);
      setGeneratingResponse(false);
      
      // Save conversation to database if user is logged in
      if (user) {
        saveConversationToDatabase(input, response);
      }
    }, 1500);
  };

  // Clear image attachment
  const clearAttachment = () => {
    setIsImageAttached(false);
    setImagePreview(null);
  };

  return {
    messages,
    input,
    setInput,
    isTyping,
    isImageAttached,
    setIsImageAttached,
    imagePreview,
    setImagePreview,
    currentLanguage,
    generatingResponse,
    handleSubmit,
    switchLanguage,
    clearAttachment,
    saveConversationToDatabase
  };
};
